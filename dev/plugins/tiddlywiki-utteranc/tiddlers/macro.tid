title: $:/plugins/oeyoews/tiddlywiki-utteranc/macro/utteranc
module-type: macro
tags: $:/tags/Macro
type: application/javascript

(function () {

	/*jslint node: true, browser: true */
	/*global $tw: false */
	"use strict";

	exports.name = "github-comments";

	exports.params = [
		{ "name": "current" },
	];

	/*
	Run the macro
	*/
	exports.run = function (current) {
		// Interactive DOM not available when generating static pages
		if (!$tw.browser) return;

		/* Remove current Utteranc.es parent element */
		const currentGhCommentsEL = document.getElementById("gh-comments");
		if (currentGhCommentsEL !== null) {
			currentGhCommentsEL.remove()
		}

		/* Load Utteranc.es */
		const script = document.createElement('script');
		script.async = true
		script.src = 'https://utteranc.es/client.js'
		script.setAttribute('repo', "oeyoews/comments" || $tw.wiki.getTiddlerText('$:/config/breakzplatform/github-comments/repo'))
		script.setAttribute('issue-term', current)
		script.setAttribute('theme', "github-light" || $tw.wiki.getTiddlerText('$:/config/breakzplatform/github-comments/theme'))
		script.setAttribute('crossorigin', 'anonymous')

		/* Create Github Comments Element */
		const ghCommentsEl = document.createElement('div');
		ghCommentsEl.id = "gh-comments";
		ghCommentsEl.appendChild(script);

		/* Append to Wrapper */
		document.querySelector('div[data-tiddler-title="' + current + '"] .gh-comments-wrapper')
			.appendChild(ghCommentsEl);

		$tw.utils.nextTick(function () {
			$tw.rootWidget.dispatchEvent({
				type: "github-comments-did-insert-element",
				target: ghCommentsEl
			});
		});
	};
})();
